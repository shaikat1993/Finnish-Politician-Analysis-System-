services:
  # ----------------- Neo4j Database -----------------
  neo4j:
    image: neo4j:enterprise
    container_name: fpas-neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"   # Web interface
      - "7687:7687"   # Bolt protocol
    # env_file removed - Neo4j should only receive specific config vars, not all from .env
    environment:
      NEO4J_AUTH: ${NEO4J_AUTH:-neo4j/12345678}
      NEO4J_dbms_default__database: ${NEO4J_DATABASE:-fpas-database}
      NEO4J_dbms_memory_pagecache_size: 1G
      NEO4J_dbms_memory_heap_initial__size: 512m
      NEO4J_dbms_memory_heap_max__size: 1G
      NEO4J_dbms_security_procedures_unrestricted: apoc.*,gds.*
      NEO4J_dbms_security_procedures_allowlist: apoc.*,gds.*
      NEO4J_apoc_import_file_enabled: "true"
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - ./neo4j/import:/import
      - ./neo4j/plugins:/plugins
    entrypoint: ["/bin/bash", "/import/init.sh"]
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u ${NEO4J_USER:-neo4j} -p ${NEO4J_PASSWORD:-12345678} -d ${NEO4J_DATABASE:-fpas-database} 'RETURN 1' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 120s
    networks:
      - fpas-network

  # ----------------- AI Pipeline -----------------
  ai_pipeline:
    build:
      context: .
      dockerfile: ai_pipeline/Dockerfile
    container_name: fpas-ai-pipeline
    restart: unless-stopped
    depends_on:
      neo4j:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-12345678}
      - NEO4J_DATABASE=${NEO4J_DATABASE:-fpas-database}
    volumes:
      - .:/app
      - ./cache:/app/cache
    networks:
      - fpas-network
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ----------------- API -----------------
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    container_name: fpas-api
    restart: unless-stopped
    depends_on:
      neo4j:
        condition: service_healthy
      ai_pipeline:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-12345678}
      - NEO4J_DATABASE=${NEO4J_DATABASE:-fpas-database}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ENVIRONMENT=docker
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MEMORY_THRESHOLD=${MEMORY_THRESHOLD:-80}
      - DISK_THRESHOLD=${DISK_THRESHOLD:-85}
      # Logging & Monitoring
      - FPAS_LOG_DIR=/app/logs
      - FPAS_LOG_LEVEL=${FPAS_LOG_LEVEL:-INFO}
      - FPAS_LOG_FORMAT=${FPAS_LOG_FORMAT:-json}
      - SMTP_SERVER=${SMTP_SERVER:-""}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME=${SMTP_USERNAME:-""}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-""}
      - SMTP_FROM=${SMTP_FROM:-""}
      - SMTP_TO=${SMTP_TO:-""}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-""}
      - ALERT_WEBHOOK_URL=${ALERT_WEBHOOK_URL:-""}
      - ALERT_WEBHOOK_HEADERS=${ALERT_WEBHOOK_HEADERS:-"{}"}
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-60}
      - CPU_THRESHOLD=${CPU_THRESHOLD:-80}
    volumes:
      - ./:/app
      - ./cache:/app/cache
      - api-logs:/app/logs
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - fpas-network

  # ----------------- Data Collection -----------------
  data_collection:
    build:
      context: .
      dockerfile: data_collection/Dockerfile
    container_name: fpas-data-collection
    restart: unless-stopped
    depends_on:
      neo4j:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-12345678}
      - NEO4J_DATABASE=${NEO4J_DATABASE:-fpas-database}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ENRICH_LIMIT=${ENRICH_LIMIT:-5}
    volumes:
      - .:/app
      - ./cache:/app/cache
    command: ["tail", "-f", "/dev/null"]  # Disable auto-start for now
    networks:
      - fpas-network

  # ----------------- Frontend -----------------
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    container_name: fpas-frontend
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    # env_file removed - prevents localhost override in Docker, .env still works for local dev
    environment:
      - API_BASE_URL=http://api:8000/api/v1
      - PYTHONPATH=/app
      - DOCKER=true
    ports:
      - "8501:8501"
    volumes:
      - .:/app
      - ./cache:/app/cache
    command: ["streamlit", "run", "/app/frontend/app.py", "--server.port=8501", "--server.address=0.0.0.0"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - fpas-network

  # ----------------- Scripts -----------------
  scripts:
    build:
      context: .
      dockerfile: scripts/Dockerfile
    container_name: fpas-scripts
    restart: "no"  # Changed to "no" since this is a utility container
    depends_on:
      neo4j:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-12345678}
      - NEO4J_DATABASE=${NEO4J_DATABASE:-fpas-database}
      - PYTHONPATH=/app
    volumes:
      - .:/app
      - ./cache:/app/cache
    entrypoint: ["tail", "-f", "/dev/null"]
    networks:
      - fpas-network
      
  # ----------------- Welcome Service -----------------
  welcome:
    image: alpine:latest
    container_name: fpas-welcome
    depends_on:
      api:
        condition: service_healthy
    env_file:
      - .env
    command: >
      sh -c 'echo "

      ğŸš€ FPAS is now running!

      ğŸ“Š Frontend:    http://localhost:8501
      ğŸ” API Docs:    http://localhost:8000/docs
      ğŸ—„ï¸ Neo4j:       http://localhost:7474

      Neo4j Login:                            
      Username: neo4j                            
      Password: 12345678 
      "'
    restart: "no"
    networks:
      - fpas-network

# ----------------- Volumes -----------------
volumes:
  api-logs:
  neo4j-data:
  neo4j-logs:

# ----------------- Networks -----------------
networks:
  fpas-network:
    driver: bridge